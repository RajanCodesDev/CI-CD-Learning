name: Production Validation

on: [push]

jobs:
    smoke-test:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: rootpassword
                    MYSQL_DATABASE: authdb
                    MYSQL_USER: authuser
                    MYSQL_PASSWORD: strongpassword
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -prootpassword"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=10

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install deps
              working-directory: simple-nodeapp
              run: npm install

            - name: wait for mysql to start
              run: |
                  for i in {1..30}; do
                  nc -z 127.0.0.1 3306 && echo "MySQL is up" && exit 0
                  sleep 10
                  done
                  echo "MySQL did not start"
                  exit 1

            - name: Initialize DB schema
              run: |
                  mysql -h 127.0.0.1 -u authuser -pstrongpassword authdb <<'EOF'
                  CREATE TABLE IF NOT EXISTS users (
                  id INT AUTO_INCREMENT PRIMARY KEY,
                  username VARCHAR(50) UNIQUE NOT NULL,
                  password_hash VARCHAR(255) NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  );
                  EOF

            - name: Start app
              working-directory: simple-nodeapp
              env:
                  DB_HOST: 127.0.0.1
                  DB_USER: authuser
                  DB_PASS: strongpassword
                  DB_NAME: authdb
                  JWT_SECRET: prodsecret
                  PORT: 3000
              run: |
                  npm start &
                  echo $! > app.pid

            - name: Wait for app
              run: |
                  for i in {1..20}; do
                    nc -z 127.0.0.1 3000 && exit 0
                    sleep 1
                  done
                  echo "App did not start"
                  exit 1

            - name: Test register
              run: |
                  curl -vf -X POST http://localhost:3000/auth/register \
                    -H "Content-Type: application/json" \
                    -d '{"username":"ciuser1","password":"12341"}'

            - name: Test login
              run: |
                  curl -vf -X POST http://localhost:3000/auth/login \
                    -H "Content-Type: application/json" \
                    -d '{"username":"ciuser1","password":"12341"}'

            - name: Stop app
              if: always()
              run: |
                  if [ -f app.pid ]; then
                  kill $(cat app.pid)
                  else
                  echo "App never started, nothing to stop"
                  fi
